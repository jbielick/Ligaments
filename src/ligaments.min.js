(function(){var __indexOf=[].indexOf||function(item){for(var i=0,l=this.length;l>i;i++)if(i in this&&this[i]===item)return i;return-1},__hasProp={}.hasOwnProperty,__slice=[].slice;!function(factory){return"function"==typeof define&&define.amd?define(["underscore","backbone"],factory):factory(_,Backbone)}(function(_,Backbone){var Ligaments;return Ligaments=function(){function Ligaments(options){return null==options&&(options={}),this.cid=_.uniqueId("ligament"),this.ensureArguments.apply(this,arguments),this.view=options.view,this.model=options.model,this.readOnly=options.readOnly,this.bindings=options.bindings,this.blacklist=options.blacklist,this.whitelist=options.whitelist,this.createBindings(),options.inject!==!1&&this.bootstrapView(),!this.readOnly&&options.ingest&&this.model.set(this.parseModel(),{silent:!0}),this}return Ligaments.prototype.createBindings=function(){return _.bindAll(this,"ingest","inject"),this.view.listenTo(this.model,"change",this.inject),this.readOnly?void 0:(_.extend(this.view.events||(this.view.events={}),{"change *[name]:not([data-bind])":this.ingest,"input *[name]:not([data-bind])":this.ingest,"change *[data-bind]":this.ingest,"input *[data-bind]":this.ingest}),this.view.delegateEvents(this.view.events))},Ligaments.prototype.ensureArguments=function(){var args;return args=[].slice.call(arguments),args.length||args[0].view||args[0].model?void 0:console.warn("You must provide an instance of a Backbone View and Model")},Ligaments.prototype.ingest=function(e){var $input,data,path,value,_ref,_this;return _this=this,this.readOnly||this.blacklist&&(_ref=!path,__indexOf.call(this.blacklist,_ref)>=0)||null!=this.whitelist&&__indexOf.call(this.whitelist,path)>=0?void 0:($input=$(this.target=e.currentTarget),path=$input.data("bind")||$input.attr("name"),path&&path.indexOf(!1)&&(path=path.replace(/\[\]/g,function(_this){return function(){return"["+_this.view.$("[name]").filter('[name="'+path+'"]').index($input)+"]"}}(this)),path=this.dotToBracketNotation(path,!0)),value=this.getVal($input,path),$input.is("select[multiple]")&&this.model.unset(path),(data={})[path]=value,data=this.expand(data),this.parse&&_.isFunction(this.model.parse)&&this.model.parse(data),null==value?this.model.unset(path):this.model.set(data),delete this.target)},Ligaments.prototype.bootstrapView=function(){return this.inject(this.model,{bootstrapData:this.model.toJSON()})},Ligaments.prototype.inject=function(model,options){var $bound,$boundTarget,data,path,value,_ref,_results;if(data=options.bootstrapData||model.changedAttributes(),this.lockBinding)return this;data=this.flatten(data),_.isFunction(this.view.beforeInject)&&this.view.beforeInject(model,data),_results=[];for(path in data)__hasProp.call(data,path)&&(value=data[path],null!=this.blacklist&&(_ref=!path,__indexOf.call(this.blacklist,_ref)>=0)||null!=this.whitelist&&__indexOf.call(this.whitelist,path)>=0?_results.push(void 0):($bound=this.getBound(path),$bound.length?$bound.is(":input")?$bound.is(":checkbox")||$bound.is(":radio")?($boundTarget=$bound.length>1?$bound.prop("checked",!1).filter('[value="'+value+'"]'):$bound,_results.push($boundTarget.prop("checked",function(){var lowerCaseString;return lowerCaseString=value.toString().toLowerCase(),value&&"off"!==lowerCaseString&&"false"!==lowerCaseString&&"no"!==lowerCaseString}))):_results.push($bound.is("select[multiple]")?$bound.val(this.model.get(path)):$bound.val(value)):_results.push($bound.is("img, svg")?$bound.attr("src",value):$bound.html(value)):_results.push(void 0)));return _results},Ligaments.prototype.parseModel=function(){var $bound,flat;return $bound=this.view.$("[data-bind], [name]"),flat={},$bound.each(function(_this){return function(idx,el){var $el,path,value;return $el=$(el),path=$el.data("bind")||$el.attr("name"),path=path.replace(/\[\]/g,function(){return"["+$bound.filter('[data-bind="'+path+'"], [name="'+path+'"]').index($el)+"]"}),null!=(value=_this.getVal($el,path))?flat[path]=value:void 0}}(this)),this.expand(flat)},Ligaments.prototype.getBound=function(path){var eqNameSelector,nameAttribute,nameSelectors;return/[0-9]+/.test(path.split("").pop())&&(path=path.split("."),path.pop(),path=path.join(".")),nameAttribute=this.dotToBracketNotation(path),eqNameSelector=nameAttribute.replace(/(.*\[)([0-9]+)?(\].*)/g,'[name="$1$3"]:eq($2)'),nameSelectors='[data-bind="'+path+'"], [name="'+path+'"] '+eqNameSelector+', [name="'+nameAttribute+'"]',this.view.$(nameSelectors).not(this.target)},Ligaments.prototype.getVal=function(input,path){var $input,args,castOptions,caster,value,_ref,_ref1;if(null==path&&(path="*"),$input=$(input),value=$input.is(":input")?!$input.is(":checkbox")&&!$input.is(":radio")||$input.prop("checked")?$input.val():void 0:$input.text(),null!=(null!=(_ref=this.bindings)&&null!=(_ref1=_ref[path])?_ref1.cast:void 0)){if(castOptions=this.bindings[path].cast,_.isFunction(this.bindings[path].cast)?(args=[],caster=castOptions):_.isArray(this.bindings[path].cast)&&(args=castOptions.slice(1),caster=castOptions[0]),!args||"function"!=typeof caster)throw new Error("options.bindings[path].cast is expected to be a function or function + arguments array ex: {cast: [parseInt, 10]}");args.unshift(value),value=caster.apply(this.model,args)||value}return value},Ligaments.prototype.matchToken=function(key,token){return"{n}"===token&&Number(key)%1===0,parseInt(token,10)%1===0&&key===parseInt(token,10),key===token},Ligaments.prototype.expand=function(flat){var child,out,parent,path,set,token,tokens,value,_i,_j,_len,_len1;for(flat.constructor!==Array&&(flat=[flat]),_i=0,_len=flat.length;_len>_i;_i++){set=flat[_i];for(path in set)if(__hasProp.call(set,path)){for(value=set[path],tokens=this.tokenize(path).reverse(),value=_.result(set,path),"{n}"!==tokens[0]&&isNaN(Number(tokens[0]))?(child={})[tokens[0]]=value:(child=[])[tokens[0]]=value,tokens.shift(),_j=0,_len1=tokens.length;_len1>_j;_j++)token=tokens[_j],isNaN(Number(token))?(parent={})[token]=child:(parent=[])[parseInt(token,10)]=child,child=parent;this.merge(out=out||(out={}),child)}}return out},Ligaments.prototype.flatten=function(data,separator,depthLimit){var curr,el,key,out,path,stack;for(null==separator&&(separator="."),null==depthLimit&&(depthLimit=!1),data=this.merge({},data),path="",stack=[],out={};_.keys(data).length>0;)_.isArray(data)&&data.length>0?(key=data.length-1,el=data.pop()):(key=_.keys(data)[0],el=data[key],delete data[key]),null==el||path.split(separator).length===depthLimit||"object"!=typeof el||el.nodeType||"object"==typeof el&&(el.constructor===Date||el.constructor===RegExp||el.constructor===Function)?out[path+key]=el:(_.keys(data).length>0&&stack.push([data,path]),data=el,path+=key+separator),0===_.keys(data).length&&stack.length>0&&(curr=stack.pop(),data=curr[0],path=curr[1]);return out},Ligaments.prototype.merge=function(){var key,object,objects,out,value,_i,_len;for(objects=1<=arguments.length?__slice.call(arguments,0):[],out=objects.shift(),_i=0,_len=objects.length;_len>_i;_i++){object=objects[_i];for(key in object)__hasProp.call(object,key)&&(value=object[key],out[key]=out[key]&&value&&(_.isObject(out[key])&&_.isObject(value)||out[key].constructor===Array)?this.merge(out[key],value):value)}return out},Ligaments.prototype.dotToBracketNotation=function(path,reverse){if(null==reverse&&(reverse=!1),!path)throw new TypeError("Not Enough Arguments");return reverse?path.replace(/\]/g,"").split("[").join("."):path.replace(/([\w]+)\.?/g,"[$1]").replace(/^\[(\w+)\]/,"$1")},Ligaments.prototype.tokenize=function(path){return-1===path.indexOf("[")?path.split("."):_.map(path.split("["),function(v){return v=v.replace(/\]/,""),""===v?"{n}":v})},Ligaments}(),Backbone.Ligament=Backbone.Ligaments=Ligaments})}).call(this);